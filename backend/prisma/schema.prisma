generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model User {
    id                          String    @id @default(uuid())
    email                       String    @unique
    password                    String
    name                        String
    isVerified                  Boolean   @default(false)
    verificationToken           String?
    lastVerificationEmailSent   DateTime?
    resetPasswordToken          String?
    resetPasswordExpires        DateTime?
    avatarUrl                   String?
    plan                        String    @default("FREE")
    phoneNumber                 String?
    birthDate                   DateTime?
    gender                      String?
    googleId                    String?
    facebookId                  String?
    hashedRefreshToken          String?
    createdAt                   DateTime  @default(now())
    updatedAt                   DateTime  @updatedAt

    setupConfig   SetupConfig?
    budgets       Budget[]
    spending      Spending[]
    assets        Asset[]
    userSettings  UserSettings?
    subscriptions Subscription[]
    payments      Payment[]
    notifications Notification[]
    chatSessions  ChatSession[]

    // Relations
    members          Member[]
    userAchievements UserAchievement[]

    @@map("users")
}

model SetupConfig {
    id     String @id @default(uuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    accountSummary String[]

    incomeSources String[]

    needs   String[]
    wants   String[]
    savings String[]

    accountAssets String[]

    paydayDate Int @default(1)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("setup_configs")
}

model Budget {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    yearMonth String

    income Json @default("{}")

    savingsAllocation Json @default("{}")

    expenses Json @default("{}")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, yearMonth])
    @@index([userId, yearMonth])
    @@map("budgets")
}

model Spending {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    date        DateTime
    description String
    category    String
    amount      Decimal  @db.Decimal(15, 2)
    checked     Boolean  @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, date])
    @@index([userId, category])
    @@map("spending")
}

enum AssetType {
    LIQUID
    NON_LIQUID
}

model Asset {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    type        AssetType
    description String
    value       Decimal   @db.Decimal(15, 2)
    account     String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, type])
    @@map("assets")
}

model UserSettings {
    id     String @id @default(uuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    assetsTarget Decimal @default(0) @db.Decimal(15, 2)
    currency     String  @default("IDR")
    language     String  @default("en")
    theme        String  @default("light")

    // Notification Preferences
    emailNotif       Boolean @default(true)
    pushNotif        Boolean @default(true)
    marketingNotif   Boolean @default(false)
    twoFactorEnabled Boolean @default(false)

    preferences Json @default("{}") // Keeping for future flexibility

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("user_settings")
}

// Member Management
model MemberGroup {
    id        String   @id @default(uuid())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    members Member[]

    @@map("member_groups")
}

enum MemberRole {
    HEAD
    SPOUSE
    CHILD
    PARENT
    MEMBER
}

model Member {
    id            String     @id @default(uuid())
    memberGroupId String
    userId        String?
    name          String
    role          MemberRole @default(MEMBER)
    relation      String?
    monthlyLimit  Decimal    @default(0) @db.Decimal(15, 2)
    isAccepted    Boolean    @default(false)
    email         String?

    group MemberGroup @relation(fields: [memberGroupId], references: [id], onDelete: Cascade)
    user  User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("members")
}

// Achievements System
model Achievement {
    id          String   @id @default(uuid())
    title       String
    description String
    icon        String
    points      Int      @default(0)
    xp          Int      @default(0)
    category    String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    userAchievements UserAchievement[]

    @@map("achievements")
}

model UserAchievement {
    id            String   @id @default(uuid())
    userId        String
    achievementId String
    unlockedAt    DateTime @default(now())

    user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

    @@unique([userId, achievementId])
    @@map("user_achievements")
}

// Subscription
enum SubscriptionPlan {
    FREE
    BASIC
    MEMBERS
}

enum SubscriptionStatus {
    ACTIVE
    CANCELLED
    EXPIRED
    PENDING
}

model Subscription {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    plan             SubscriptionPlan
    status           SubscriptionStatus @default(PENDING)
    startDate        DateTime
    endDate          DateTime
    autoRenew        Boolean            @default(true)
    cancelledAt      DateTime?
    cancellationNote String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, status])
    @@map("subscriptions")
}

enum PaymentStatus {
    PENDING
    SUCCESS
    FAILED
    EXPIRED
    CANCELLED
}

enum PaymentMethod {
    MIDTRANS
    MANUAL
}

model Payment {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    orderId       String        @unique
    amount        Decimal       @db.Decimal(15, 2)
    status        PaymentStatus @default(PENDING)
    paymentMethod PaymentMethod
    midtransToken String?
    midtransUrl   String?
    paidAt        DateTime?
    expiredAt     DateTime?
    metadata      Json          @default("{}")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, status])
    @@index([orderId])
    @@map("payments")
}

enum NotificationType {
    INFO
    SUCCESS
    WARNING
    ERROR
    PAYMENT
    SYSTEM
}

model Notification {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    type     NotificationType
    title    String
    message  String
    isRead   Boolean          @default(false)
    readAt   DateTime?
    link     String?
    metadata Json             @default("{}")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, isRead])
    @@index([userId, createdAt])
    @@map("notifications")
}

model ChatSession {
    id     String @id @default(uuid())
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    title    String?
    isActive Boolean       @default(true)
    messages ChatMessage[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, isActive])
    @@map("chat_sessions")
}

enum ChatRole {
    USER
    ASSISTANT
    SYSTEM
}

model ChatMessage {
    id        String      @id @default(uuid())
    sessionId String
    session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

    role     ChatRole
    content  String   @db.Text
    metadata Json     @default("{}")

    createdAt DateTime @default(now())

    @@index([sessionId, createdAt])
    @@map("chat_messages")
}
